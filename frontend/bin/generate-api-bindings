#!/usr/bin/env bash

# liberally copied from the event capture project.  Thanks Tom!
# https://github.com/openstax/event-capture-client/blob/master/script/build-swagger-client.bash

set -e; if [ -n "$DEBUG" ]; then set -x; fi

if [ -z "$(which docker)" ]; then
  echo "docker is required to build swagger" > /dev/stderr;
  exit 1;
fi

if [ -z "$(which yarn)" ]; then
  echo "yarn is required to build swagger" > /dev/stderr;
  exit 1;
fi

version=${VERSION:-"0"}
api_host=${API_HOST:-"dos.labs.sandbox.openstax.org"}
swagger_path="/api/v${version}/swagger.json"

secure=${SECURE:-"true"}
protocol=$(test "$secure" = "true" && echo "https" || echo "http")
json_url="$protocol://$api_host$swagger_path"

project_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." >/dev/null 2>&1 && pwd )"
temp_dir=$(mktemp -d -t ci-XXXXXXXXXX)

echo "getting swagger json from: $json_url"
echo "wrangling swagger file: $temp_dir/swagger.json" > /dev/stderr;

curl -s $json_url \
  | docker run --rm -i stedolan/jq --arg host "$api_host" --arg protocol "$protocol" '. + {host: $host, schemes: [$protocol]}' \
  > "$temp_dir/swagger.json"

echo "building swagger into: $temp_dir/src" > /dev/stderr;

docker run --rm -v "$temp_dir:/shared" openapitools/openapi-generator-cli generate \
  -i /shared/swagger.json \
  -g typescript-fetch \
  -o /shared/src

echo "compiling typescript" > /dev/stderr;
cd "$temp_dir/src"

# swagger ts breaks on more recent version
yarn add typescript@3.5
yarn tsc --module commonjs --target es6 --lib es2015,dom --outDir dist --declaration index.ts

rm -rf "$project_dir/src/api"
mv dist "$project_dir/src/api"

echo "api bindings saved to: $project_dir/src/api"
